"use client";
import React, { useState, useEffect } from 'react';
import Sidebar from '@/components/Sidebar';
import ExportButton from '@/components/ExportButton';

export default function RaporlarPage() {
    const [plants, setPlants] = useState<any[]>([]);
    const [production, setProduction] = useState<any[]>([]);
    const [expenses, setExpenses] = useState<any[]>([]);
    const [sales, setSales] = useState<any[]>([]);
    const [purchases, setPurchases] = useState<any[]>([]);
    const [fertilizerLogs, setFertilizerLogs] = useState<any[]>([]);
    const [temperatureLogs, setTemperatureLogs] = useState<any[]>([]);
    const [isLoading, setIsLoading] = useState(true);
    const [activeSection, setActiveSection] = useState<'overview' | 'monthly' | 'cost' | 'operations'>('overview');

    const API_URL = process.env.NEXT_PUBLIC_API_URL || '/api';

    useEffect(() => {
        fetchAllData();
    }, []);

    const fetchAllData = async () => {
        setIsLoading(true);
        try {
            const [pRes, prodRes, expRes, sRes, purchRes, fertRes, tempRes] = await Promise.all([
                fetch(`${API_URL}/plants?tenantId=demo-tenant`),
                fetch(`${API_URL}/production/batches?tenantId=demo-tenant`),
                fetch(`${API_URL}/finans/expenses?tenantId=demo-tenant`),
                fetch(`${API_URL}/sales/orders?tenantId=demo-tenant`),
                fetch(`${API_URL}/purchases?tenantId=demo-tenant`),
                fetch(`${API_URL}/production/fertilizer-logs?tenantId=demo-tenant`).catch(() => ({ ok: false })),
                fetch(`${API_URL}/production/temperature-logs?tenantId=demo-tenant`).catch(() => ({ ok: false }))
            ]);

            if (pRes.ok) setPlants(await pRes.json());
            if (prodRes.ok) setProduction(await prodRes.json());
            if (expRes.ok) setExpenses(await expRes.json());
            if (sRes.ok) setSales(await sRes.json());
            if (purchRes.ok) setPurchases(await purchRes.json());
            if ('json' in fertRes && fertRes.ok) setFertilizerLogs(await fertRes.json());
            if ('json' in tempRes && tempRes.ok) setTemperatureLogs(await tempRes.json());
        } catch (err) {
            console.error('Rapor verileri y√ºklenemedi:', err);
        } finally {
            setIsLoading(false);
        }
    };

    // Calculations
    const totalStock = plants.reduce((sum, p) => sum + (p.currentStock || 0), 0);
    const totalBatches = production.length;
    const totalCuttings = production.reduce((sum, b) => sum + (b.quantity || 0), 0);
    const totalSalesIncome = sales.filter(s => s.status === 'Tamamlandƒ±').reduce((sum, s) => sum + (s.totalAmount || 0), 0);
    const totalPurchaseCost = purchases.filter(p => p.status === 'Tamamlandƒ±').reduce((sum, p) => sum + (p.totalAmount || 0), 0);
    const totalOperatingExpense = expenses.reduce((sum, e) => sum + (Number(e.amount) || 0), 0);
    const totalExpense = totalPurchaseCost + totalOperatingExpense;
    const netProfit = totalSalesIncome - totalExpense;

    // Monthly breakdown
    const getMonthlyData = () => {
        const months: Record<string, { income: number, expense: number }> = {};
        sales.filter(s => s.status === 'Tamamlandƒ±').forEach(s => {
            const month = new Date(s.orderDate).toLocaleDateString('tr-TR', { year: 'numeric', month: 'short' });
            if (!months[month]) months[month] = { income: 0, expense: 0 };
            months[month].income += s.totalAmount || 0;
        });
        expenses.forEach(e => {
            const month = new Date(e.date).toLocaleDateString('tr-TR', { year: 'numeric', month: 'short' });
            if (!months[month]) months[month] = { income: 0, expense: 0 };
            months[month].expense += Number(e.amount) || 0;
        });
        purchases.filter(p => p.status === 'Tamamlandƒ±').forEach(p => {
            const month = new Date(p.orderDate).toLocaleDateString('tr-TR', { year: 'numeric', month: 'short' });
            if (!months[month]) months[month] = { income: 0, expense: 0 };
            months[month].expense += p.totalAmount || 0;
        });
        return Object.entries(months).sort((a, b) => a[0].localeCompare(b[0]));
    };

    // Expense categories
    const getExpenseByCategory = () => {
        const cats: Record<string, number> = {};
        expenses.forEach(e => {
            const cat = e.category || 'Diƒüer';
            cats[cat] = (cats[cat] || 0) + (Number(e.amount) || 0);
        });
        return Object.entries(cats).sort((a, b) => b[1] - a[1]);
    };

    // Plant cost analysis from production batches
    const getPlantCosts = () => {
        return production
            .filter(b => b.quantity > 0)
            .map(b => ({
                name: b.name || b.plantName || 'ƒ∞simsiz',
                lotId: b.lotId,
                quantity: b.quantity,
                totalCost: b.accumulatedCost || 0,
                unitCost: b.quantity > 0 ? (b.accumulatedCost || 0) / b.quantity : 0,
                location: b.location || 'Belirsiz',
                stage: b.stage || '-'
            }))
            .sort((a, b) => b.unitCost - a.unitCost);
    };

    const monthlyData = getMonthlyData();
    const expenseCategories = getExpenseByCategory();
    const plantCosts = getPlantCosts();
    const maxMonthlyValue = Math.max(...monthlyData.map(([, d]) => Math.max(d.income, d.expense)), 1);

    const tabs = [
        { id: 'overview' as const, label: 'Genel Durum', icon: 'üìä' },
        { id: 'monthly' as const, label: 'Aylƒ±k Rapor', icon: 'üìÖ' },
        { id: 'cost' as const, label: 'Maliyet Analizi', icon: 'üí∞' },
        { id: 'operations' as const, label: 'Operasyonlar', icon: 'üå°Ô∏è' },
    ];

    return (
        <div className="flex flex-col lg:flex-row min-h-screen bg-[#f8fafc] font-sans">
            <Sidebar />
            <main className="flex-1 min-w-0">
                <header className="bg-white border-b border-slate-200 px-4 lg:px-8 py-4 lg:py-5 flex flex-row justify-between items-center sticky top-0 z-30 shadow-sm gap-4">
                    <div>
                        <h1 className="text-xl lg:text-2xl font-bold text-slate-800 tracking-tight">Geli≈ümi≈ü Raporlar</h1>
                        <p className="hidden lg:block text-xs lg:text-sm text-slate-500">ƒ∞≈ületmenizin t√ºm verilerini tek ekrandan inceleyin.</p>
                    </div>
                    <div className="flex gap-3">
                        <ExportButton title="Genel Rapor" tableId="report-table" iconOnly={true} />
                        <button
                            onClick={fetchAllData}
                            title="Verileri Yenile"
                            className="bg-white border border-slate-200 text-slate-600 w-10 h-10 rounded-full flex items-center justify-center font-bold shadow-sm hover:bg-slate-50 transition active:scale-95 group"
                        >
                            <span className="text-lg group-hover:rotate-180 transition duration-500">üîÑ</span>
                        </button>
                    </div>
                </header>

                {/* Tab Navigation */}
                <div className="sticky top-[73px] lg:top-[81px] z-20 bg-[#f8fafc]/90 backdrop-blur-md border-b border-slate-200/60 py-3 px-4 lg:px-8 shadow-sm">
                    <div className="flex gap-2 overflow-x-auto no-scrollbar snap-x">
                        {tabs.map(tab => (
                            <button
                                key={tab.id}
                                onClick={() => setActiveSection(tab.id)}
                                className={`
                                    snap-start shrink-0 px-5 py-2.5 rounded-full text-xs font-black uppercase tracking-widest transition-all border
                                    ${activeSection === tab.id
                                        ? 'bg-slate-800 text-white border-slate-800 shadow-md transform scale-105'
                                        : 'bg-white text-slate-400 border-slate-200 hover:border-slate-300 hover:text-slate-600'
                                    }
                                `}
                            >
                                <span className="mr-2 text-sm">{tab.icon}</span>
                                {tab.label}
                            </button>
                        ))}
                    </div>
                </div>

                <div className="p-4 lg:p-8 space-y-8">
                    {isLoading ? (
                        <div className="py-24 text-center">
                            <div className="inline-block w-10 h-10 border-4 border-emerald-500 border-t-transparent rounded-full animate-spin"></div>
                            <p className="text-slate-400 mt-4 font-bold text-[10px] uppercase tracking-widest">Rapor Verileri Y√ºkleniyor...</p>
                        </div>
                    ) : (
                        <>
                            {/* ===================== OVERVIEW ===================== */}
                            {activeSection === 'overview' && (
                                <div className="space-y-8 animate-fade-in">
                                    {/* KPI Cards */}
                                    <div className="grid grid-cols-2 md:grid-cols-3 xl:grid-cols-6 gap-4">
                                        <KPICard icon="üå±" label="Toplam Stok" value={totalStock.toLocaleString()} color="emerald" />
                                        <KPICard icon="üß™" label="√úretim Partisi" value={totalBatches.toString()} color="blue" />
                                        <KPICard icon="üåø" label="Toplam √áelik" value={totalCuttings.toLocaleString()} color="teal" />
                                        <KPICard icon="üí∞" label="Satƒ±≈ü Geliri" value={`‚Ç∫${totalSalesIncome.toLocaleString('tr-TR')}`} color="emerald" />
                                        <KPICard icon="üìâ" label="Toplam Gider" value={`‚Ç∫${totalExpense.toLocaleString('tr-TR')}`} color="rose" />
                                        <KPICard icon={netProfit >= 0 ? "üéâ" : "‚ö†Ô∏è"} label="Net Kar/Zarar" value={`‚Ç∫${netProfit.toLocaleString('tr-TR')}`} color={netProfit >= 0 ? "blue" : "amber"} />
                                    </div>

                                    {/* Stock by Type */}
                                    <div className="grid grid-cols-1 xl:grid-cols-2 gap-8">
                                        <div className="bg-white rounded-2xl border border-slate-200 shadow-sm p-6">
                                            <h3 className="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-6">Stok Daƒüƒ±lƒ±mƒ± (T√ºr Bazƒ±nda)</h3>
                                            <div className="space-y-3">
                                                {['MOTHER_TREE', 'CUTTING', 'RAW_MATERIAL', 'PACKAGING'].map(type => {
                                                    const items = plants.filter(p => p.type === type);
                                                    const total = items.reduce((s, p) => s + (p.currentStock || 0), 0);
                                                    const labels: Record<string, string> = { MOTHER_TREE: 'üå≥ Ana Aƒüa√ß', CUTTING: 'üå± √úretim Materyali', RAW_MATERIAL: 'üß± Hammadde', PACKAGING: 'üì¶ Ambalaj' };
                                                    return (
                                                        <div key={type} className="flex items-center justify-between p-3 bg-slate-50 rounded-xl">
                                                            <span className="text-sm font-bold text-slate-600">{labels[type] || type}</span>
                                                            <div className="text-right">
                                                                <span className="font-bold text-slate-800">{total.toLocaleString()}</span>
                                                                <span className="text-[10px] text-slate-400 ml-1">({items.length} √ße≈üit)</span>
                                                            </div>
                                                        </div>
                                                    );
                                                })}
                                            </div>
                                        </div>

                                        <div className="bg-white rounded-2xl border border-slate-200 shadow-sm p-6">
                                            <h3 className="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-6">Gider Daƒüƒ±lƒ±mƒ± (Kategori)</h3>
                                            <div className="space-y-3">
                                                {expenseCategories.length === 0 ? (
                                                    <p className="text-slate-400 italic text-sm text-center py-6">Gider kaydƒ± yok.</p>
                                                ) : (
                                                    expenseCategories.map(([cat, amount]) => {
                                                        const maxCat = expenseCategories[0][1];
                                                        const pct = maxCat > 0 ? (amount / maxCat) * 100 : 0;
                                                        return (
                                                            <div key={cat}>
                                                                <div className="flex justify-between text-sm mb-1">
                                                                    <span className="font-bold text-slate-600">{cat}</span>
                                                                    <span className="font-bold text-rose-600">‚Ç∫{amount.toLocaleString('tr-TR')}</span>
                                                                </div>
                                                                <div className="w-full h-2 bg-slate-100 rounded-full overflow-hidden">
                                                                    <div className="h-full bg-gradient-to-r from-rose-400 to-rose-600 rounded-full transition-all duration-700" style={{ width: `${pct}%` }}></div>
                                                                </div>
                                                            </div>
                                                        );
                                                    })
                                                )}
                                            </div>
                                        </div>
                                    </div>

                                    {/* Tedarik√ßi √ñzet */}
                                    <div className="bg-white rounded-2xl border border-slate-200 shadow-sm p-6">
                                        <h3 className="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-6">Tedarik√ßi Sipari≈ü √ñzeti</h3>
                                        <div className="hidden lg:block overflow-x-auto">
                                            <table className="w-full text-left text-sm" id="report-table">
                                                <thead className="bg-slate-50 text-[10px] font-black text-slate-500 uppercase tracking-widest">
                                                    <tr>
                                                        <th className="px-4 py-3">Tedarik√ßi</th>
                                                        <th className="px-4 py-3 text-center">Sipari≈ü Sayƒ±sƒ±</th>
                                                        <th className="px-4 py-3 text-center">Tamamlanan</th>
                                                        <th className="px-4 py-3 text-right">Toplam Tutar</th>
                                                    </tr>
                                                </thead>
                                                <tbody className="divide-y divide-slate-100">
                                                    {(() => {
                                                        const suppliers: Record<string, { count: number, completed: number, total: number }> = {};
                                                        purchases.forEach(p => {
                                                            const s = p.supplier || 'Bilinmeyen';
                                                            if (!suppliers[s]) suppliers[s] = { count: 0, completed: 0, total: 0 };
                                                            suppliers[s].count++;
                                                            if (p.status === 'Tamamlandƒ±') {
                                                                suppliers[s].completed++;
                                                                suppliers[s].total += p.totalAmount || 0;
                                                            }
                                                        });
                                                        const supplierEntries = Object.entries(suppliers);
                                                        return (
                                                            <>
                                                                {supplierEntries.map(([name, data]) => (
                                                                    <tr key={name} className="hover:bg-slate-50">
                                                                        <td className="px-4 py-3 font-bold text-slate-700">{name}</td>
                                                                        <td className="px-4 py-3 text-center font-mono">{data.count}</td>
                                                                        <td className="px-4 py-3 text-center font-mono text-emerald-600">{data.completed}</td>
                                                                        <td className="px-4 py-3 text-right font-bold text-slate-800">‚Ç∫{data.total.toLocaleString('tr-TR')}</td>
                                                                    </tr>
                                                                ))}
                                                            </>
                                                        );
                                                    })()}
                                                    {purchases.length === 0 && (
                                                        <tr><td colSpan={4} className="py-8 text-center text-slate-400 italic">Sipari≈ü kaydƒ± yok.</td></tr>
                                                    )}
                                                </tbody>
                                            </table>
                                        </div>

                                        {/* Mobile Card View for Suppliers */}
                                        <div className="lg:hidden space-y-3">
                                            {(() => {
                                                const suppliers: Record<string, { count: number, completed: number, total: number }> = {};
                                                purchases.forEach(p => {
                                                    const s = p.supplier || 'Bilinmeyen';
                                                    if (!suppliers[s]) suppliers[s] = { count: 0, completed: 0, total: 0 };
                                                    suppliers[s].count++;
                                                    if (p.status === 'Tamamlandƒ±') {
                                                        suppliers[s].completed++;
                                                        suppliers[s].total += p.totalAmount || 0;
                                                    }
                                                });
                                                const supplierEntries = Object.entries(suppliers);

                                                if (supplierEntries.length === 0) return <p className="text-slate-400 italic text-sm text-center py-6">Sipari≈ü kaydƒ± yok.</p>;

                                                return supplierEntries.map(([name, data]) => (
                                                    <div key={name} className="p-4 bg-slate-50 rounded-xl border border-slate-100 flex justify-between items-center">
                                                        <div>
                                                            <h4 className="font-bold text-slate-700 text-sm mb-1">{name}</h4>
                                                            <div className="flex gap-2 text-[10px] text-slate-500">
                                                                <span className="bg-white px-2 py-0.5 rounded border border-slate-200">Toplam: {data.count}</span>
                                                                <span className="bg-emerald-50 text-emerald-600 px-2 py-0.5 rounded border border-emerald-100">Tamamlanan: {data.completed}</span>
                                                            </div>
                                                        </div>
                                                        <span className="font-bold text-slate-800 text-sm">‚Ç∫{data.total.toLocaleString('tr-TR')}</span>
                                                    </div>
                                                ));
                                            })()}
                                        </div>
                                    </div>
                                </div>
                            )}

                            {/* ===================== MONTHLY ===================== */}
                            {activeSection === 'monthly' && (
                                <div className="space-y-8 animate-fade-in">
                                    <div className="bg-white rounded-2xl border border-slate-200 shadow-sm p-6">
                                        <h3 className="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-6">Aylƒ±k Gelir / Gider Kar≈üƒ±la≈ütƒ±rmasƒ±</h3>
                                        {monthlyData.length === 0 ? (
                                            <p className="text-slate-400 italic text-sm text-center py-12">Yeterli veri yok.</p>
                                        ) : (
                                            <div className="space-y-4">
                                                {monthlyData.map(([month, data]) => (
                                                    <div key={month} className="p-4 rounded-xl border border-slate-100 bg-slate-50/50">
                                                        <div className="flex justify-between items-center mb-3">
                                                            <span className="font-bold text-slate-700 text-sm">{month}</span>
                                                            <span className={`font-bold text-xs px-2 py-1 rounded-lg ${(data.income - data.expense) >= 0 ? 'bg-emerald-50 text-emerald-600' : 'bg-rose-50 text-rose-600'}`}>
                                                                {(data.income - data.expense) >= 0 ? '+' : ''}{(data.income - data.expense).toLocaleString('tr-TR', { style: 'currency', currency: 'TRY' })}
                                                            </span>
                                                        </div>
                                                        <div className="space-y-2">
                                                            <div>
                                                                <div className="flex justify-between text-[10px] font-bold text-slate-500 mb-1">
                                                                    <span>Gelir</span>
                                                                    <span className="text-emerald-600">‚Ç∫{data.income.toLocaleString('tr-TR')}</span>
                                                                </div>
                                                                <div className="w-full h-2.5 bg-slate-100 rounded-full overflow-hidden">
                                                                    <div className="h-full bg-gradient-to-r from-emerald-400 to-emerald-600 rounded-full transition-all duration-700" style={{ width: `${(data.income / maxMonthlyValue) * 100}%` }}></div>
                                                                </div>
                                                            </div>
                                                            <div>
                                                                <div className="flex justify-between text-[10px] font-bold text-slate-500 mb-1">
                                                                    <span>Gider</span>
                                                                    <span className="text-rose-600">‚Ç∫{data.expense.toLocaleString('tr-TR')}</span>
                                                                </div>
                                                                <div className="w-full h-2.5 bg-slate-100 rounded-full overflow-hidden">
                                                                    <div className="h-full bg-gradient-to-r from-rose-400 to-rose-600 rounded-full transition-all duration-700" style={{ width: `${(data.expense / maxMonthlyValue) * 100}%` }}></div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                ))}
                                            </div>
                                        )}
                                    </div>
                                </div>
                            )}

                            {/* ===================== COST ANALYSIS ===================== */}
                            {activeSection === 'cost' && (
                                <div className="space-y-8 animate-fade-in">
                                    <div className="bg-white rounded-2xl border border-slate-200 shadow-sm overflow-hidden">
                                        <div className="p-6 border-b border-slate-100 bg-slate-50/50">
                                            <h3 className="text-[10px] font-black text-slate-400 uppercase tracking-widest">Bitki Bazlƒ± Maliyet Analizi (√úretim Partileri)</h3>
                                        </div>
                                        <div className="hidden lg:block overflow-x-auto">
                                            <table className="w-full text-left text-sm">
                                                <thead className="bg-white text-[10px] font-black text-slate-400 uppercase tracking-widest border-b border-slate-100">
                                                    <tr>
                                                        <th className="px-6 py-4">Parti / √úr√ºn</th>
                                                        <th className="px-6 py-4 text-center">Miktar</th>
                                                        <th className="px-6 py-4 text-center">Konum</th>
                                                        <th className="px-6 py-4 text-center">Safha</th>
                                                        <th className="px-6 py-4 text-right">Toplam Maliyet</th>
                                                        <th className="px-6 py-4 text-right">Birim Maliyet</th>
                                                    </tr>
                                                </thead>
                                                <tbody className="divide-y divide-slate-50">
                                                    {plantCosts.map((pc, i) => (
                                                        <tr key={i} className="hover:bg-slate-50 transition">
                                                            <td className="px-6 py-4">
                                                                <p className="font-bold text-slate-700">{pc.name}</p>
                                                                <p className="text-[10px] text-emerald-600 font-mono">{pc.lotId}</p>
                                                            </td>
                                                            <td className="px-6 py-4 text-center font-mono font-bold">{pc.quantity.toLocaleString()}</td>
                                                            <td className="px-6 py-4 text-center">
                                                                <span className="px-2 py-1 bg-slate-100 rounded-lg text-xs font-bold text-slate-600">{pc.location}</span>
                                                            </td>
                                                            <td className="px-6 py-4 text-center text-xs font-bold text-slate-500 uppercase">{pc.stage}</td>
                                                            <td className="px-6 py-4 text-right font-bold text-slate-800">‚Ç∫{pc.totalCost.toFixed(2)}</td>
                                                            <td className="px-6 py-4 text-right">
                                                                <span className={`font-bold ${pc.unitCost > 5 ? 'text-rose-600' : 'text-emerald-600'}`}>
                                                                    ‚Ç∫{pc.unitCost.toFixed(2)}
                                                                </span>
                                                            </td>
                                                        </tr>
                                                    ))}
                                                    {plantCosts.length === 0 && (
                                                        <tr><td colSpan={6} className="py-12 text-center text-slate-400 italic">√úretim partisi bulunamadƒ±.</td></tr>
                                                    )}
                                                </tbody>
                                            </table>
                                        </div>

                                        {/* Mobile Card View for Cost Analysis */}
                                        <div className="lg:hidden divide-y divide-slate-100">
                                            {plantCosts.map((pc, i) => (
                                                <div key={i} className="p-4 first:pt-0">
                                                    <div className="flex justify-between items-start mb-2">
                                                        <div>
                                                            <h4 className="font-bold text-slate-800 text-sm">{pc.name}</h4>
                                                            <span className="text-[10px] text-emerald-600 font-mono bg-emerald-50 px-1.5 py-0.5 rounded">{pc.lotId}</span>
                                                        </div>
                                                        <div className="text-right">
                                                            <div className={`font-bold text-sm ${pc.unitCost > 5 ? 'text-rose-600' : 'text-emerald-600'}`}>
                                                                ‚Ç∫{pc.unitCost.toFixed(2)} <span className="text-[10px] text-slate-400 font-normal">/ adet</span>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div className="grid grid-cols-3 gap-2 text-[10px] text-slate-500 mt-3">
                                                        <div className="bg-slate-50 p-2 rounded text-center">
                                                            <span className="block font-bold text-slate-700">{pc.quantity.toLocaleString()}</span>
                                                            <span>Miktar</span>
                                                        </div>
                                                        <div className="bg-slate-50 p-2 rounded text-center">
                                                            <span className="block font-bold text-slate-700">{pc.location}</span>
                                                            <span>Konum</span>
                                                        </div>
                                                        <div className="bg-slate-50 p-2 rounded text-center">
                                                            <span className="block font-bold text-slate-700">‚Ç∫{pc.totalCost.toFixed(0)}</span>
                                                            <span>Top. Mal.</span>
                                                        </div>
                                                    </div>
                                                </div>
                                            ))}
                                            {plantCosts.length === 0 && <p className="text-slate-400 italic text-sm text-center py-6">Kayƒ±t yok.</p>}
                                        </div>
                                    </div>

                                    {/* Labor & Energy Summary */}
                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                        <div className="bg-white rounded-2xl border border-slate-200 shadow-sm p-6">
                                            <h3 className="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-4">üë∑ ƒ∞≈ü√ßilik Giderleri</h3>
                                            {(() => {
                                                const laborExpenses = expenses.filter(e => e.category === 'ƒ∞≈ü√ßilik');
                                                const laborTotal = laborExpenses.reduce((s, e) => s + (Number(e.amount) || 0), 0);
                                                return (
                                                    <div>
                                                        <p className="text-3xl font-black text-slate-800 mb-2">‚Ç∫{laborTotal.toLocaleString('tr-TR')}</p>
                                                        <p className="text-xs text-slate-400">{laborExpenses.length} kayƒ±t</p>
                                                        <div className="mt-4 space-y-2 max-h-48 overflow-y-auto">
                                                            {laborExpenses.slice(0, 10).map((e, i) => (
                                                                <div key={i} className="flex justify-between items-center text-xs p-2 bg-slate-50 rounded-lg">
                                                                    <span className="text-slate-600 truncate max-w-[60%]">{e.description}</span>
                                                                    <span className="font-bold text-slate-800">‚Ç∫{Number(e.amount).toLocaleString('tr-TR')}</span>
                                                                </div>
                                                            ))}
                                                        </div>
                                                    </div>
                                                );
                                            })()}
                                        </div>
                                        <div className="bg-white rounded-2xl border border-slate-200 shadow-sm p-6">
                                            <h3 className="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-4">‚ö° Enerji Giderleri</h3>
                                            {(() => {
                                                const energyExpenses = expenses.filter(e => e.category === 'Enerji');
                                                const energyTotal = energyExpenses.reduce((s, e) => s + (Number(e.amount) || 0), 0);
                                                return (
                                                    <div>
                                                        <p className="text-3xl font-black text-slate-800 mb-2">‚Ç∫{energyTotal.toLocaleString('tr-TR')}</p>
                                                        <p className="text-xs text-slate-400">{energyExpenses.length} kayƒ±t</p>
                                                        <div className="mt-4 space-y-2 max-h-48 overflow-y-auto">
                                                            {energyExpenses.slice(0, 10).map((e, i) => (
                                                                <div key={i} className="flex justify-between items-center text-xs p-2 bg-slate-50 rounded-lg">
                                                                    <span className="text-slate-600 truncate max-w-[60%]">{e.description}</span>
                                                                    <span className="font-bold text-slate-800">‚Ç∫{Number(e.amount).toLocaleString('tr-TR')}</span>
                                                                </div>
                                                            ))}
                                                        </div>
                                                    </div>
                                                );
                                            })()}
                                        </div>
                                    </div>
                                </div>
                            )}

                            {/* ===================== OPERATIONS ===================== */}
                            {activeSection === 'operations' && (
                                <div className="grid grid-cols-1 lg:grid-cols-3 gap-8 animate-fade-in">
                                    <div className="lg:col-span-2 space-y-8">
                                        <TemperatureChart data={temperatureLogs} />

                                        <div className="bg-white rounded-2xl border border-slate-200 shadow-sm overflow-hidden">
                                            <div className="p-6 border-b border-slate-100 bg-slate-50/50 flex justify-between items-center">
                                                <h3 className="text-[10px] font-black text-slate-400 uppercase tracking-widest">üå°Ô∏è Sera Sƒ±caklƒ±k Kayƒ±tlarƒ±</h3>
                                                <span className="text-xs font-bold text-purple-600 bg-purple-50 px-3 py-1 rounded-full">{temperatureLogs.length} Kayƒ±t</span>
                                            </div>
                                            <div className="hidden lg:block overflow-x-auto">
                                                <table className="w-full text-left text-sm">
                                                    <thead className="bg-white text-[10px] font-black text-slate-400 uppercase tracking-widest border-b border-slate-100">
                                                        <tr>
                                                            <th className="px-4 py-3">Tarih</th>
                                                            <th className="px-4 py-3 text-center" colSpan={3}>Sera ƒ∞√ßi (S/√ñ/A)</th>
                                                            <th className="px-4 py-3 text-center" colSpan={3}>Sera Dƒ±≈üƒ± (S/√ñ/A)</th>
                                                            <th className="px-4 py-3 text-center">Mazot</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody className="divide-y divide-slate-50">
                                                        {temperatureLogs.slice(0, 20).map((log: any, i: number) => {
                                                            const si = log.seraIci || {};
                                                            const sd = log.seraDisi || {};
                                                            const dateStr = log.date ? new Date(log.date).toLocaleDateString('tr-TR', { day: '2-digit', month: '2-digit', year: 'numeric' }) : '-';
                                                            return (
                                                                <tr key={i} className="hover:bg-slate-50">
                                                                    <td className="px-4 py-3 text-slate-500 font-mono text-xs">{dateStr}</td>
                                                                    <td className="px-2 py-3 text-center text-xs font-bold text-orange-500">{si.sabah != null ? `${si.sabah}¬∞` : '-'}</td>
                                                                    <td className="px-2 py-3 text-center text-xs font-bold text-orange-600">{si.ogle != null ? `${si.ogle}¬∞` : '-'}</td>
                                                                    <td className="px-2 py-3 text-center text-xs font-bold text-orange-400">{si.aksam != null ? `${si.aksam}¬∞` : '-'}</td>
                                                                    <td className="px-2 py-3 text-center text-xs font-bold text-blue-500">{sd.sabah != null ? `${sd.sabah}¬∞` : '-'}</td>
                                                                    <td className="px-2 py-3 text-center text-xs font-bold text-blue-600">{sd.ogle != null ? `${sd.ogle}¬∞` : '-'}</td>
                                                                    <td className="px-2 py-3 text-center text-xs font-bold text-blue-400">{sd.aksam != null ? `${sd.aksam}¬∞` : '-'}</td>
                                                                    <td className="px-4 py-3 text-center text-xs font-bold text-slate-600">{log.mazot != null ? `${log.mazot} Lt` : '-'}</td>
                                                                </tr>
                                                            );
                                                        })}
                                                        {temperatureLogs.length === 0 && (
                                                            <tr><td colSpan={8} className="py-8 text-center text-slate-400 italic">Sƒ±caklƒ±k kaydƒ± yok.</td></tr>
                                                        )}
                                                    </tbody>
                                                </table>
                                            </div>

                                            {/* Mobile Card View for Temperatures */}
                                            <div className="lg:hidden space-y-3 p-4">
                                                {temperatureLogs.slice(0, 10).map((log: any, i: number) => {
                                                    const si = log.seraIci || {};
                                                    const sd = log.seraDisi || {};
                                                    const dateStr = log.date ? new Date(log.date).toLocaleDateString('tr-TR', { day: 'numeric', month: 'long' }) : '-';
                                                    return (
                                                        <div key={i} className="bg-slate-50 p-4 rounded-xl border border-slate-100">
                                                            <div className="flex justify-between items-center mb-3">
                                                                <span className="font-bold text-slate-700 text-sm">{dateStr}</span>
                                                                {log.mazot && <span className="text-[10px] font-bold text-purple-600 bg-purple-50 px-2 py-0.5 rounded">‚õΩ {log.mazot} Lt</span>}
                                                            </div>
                                                            <div className="grid grid-cols-2 gap-3">
                                                                <div className="bg-white p-2 rounded-lg border border-orange-100">
                                                                    <span className="block text-[9px] font-black text-orange-400 uppercase mb-1 text-center">Sera ƒ∞√ßi</span>
                                                                    <div className="flex justify-between text-xs font-bold text-orange-600">
                                                                        <span>S:{si.sabah ?? '-'}</span>
                                                                        <span>√ñ:{si.ogle ?? '-'}</span>
                                                                        <span>A:{si.aksam ?? '-'}</span>
                                                                    </div>
                                                                </div>
                                                                <div className="bg-white p-2 rounded-lg border border-blue-100">
                                                                    <span className="block text-[9px] font-black text-blue-400 uppercase mb-1 text-center">Dƒ±≈üarƒ±</span>
                                                                    <div className="flex justify-between text-xs font-bold text-blue-600">
                                                                        <span>S:{sd.sabah ?? '-'}</span>
                                                                        <span>√ñ:{sd.ogle ?? '-'}</span>
                                                                        <span>A:{sd.aksam ?? '-'}</span>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    );
                                                })}
                                                {temperatureLogs.length === 0 && <p className="text-slate-400 italic text-sm text-center">Kayƒ±t yok.</p>}
                                            </div>
                                        </div>
                                    </div>

                                    <div className="space-y-8">
                                        {/* Fertilizer Logs */}
                                        <div className="bg-white rounded-2xl border border-slate-200 shadow-sm overflow-hidden h-full">
                                            <div className="p-6 border-b border-slate-100 bg-slate-50/50 flex justify-between items-center">
                                                <h3 className="text-[10px] font-black text-slate-400 uppercase tracking-widest">üåø G√ºbre Uygulama</h3>
                                                <span className="text-xs font-bold text-emerald-600 bg-emerald-50 px-3 py-1 rounded-full">{fertilizerLogs.length}</span>
                                            </div>
                                            <div className="hidden lg:block overflow-x-auto">
                                                <table className="w-full text-left text-sm">
                                                    <thead className="bg-white text-[10px] font-black text-slate-400 uppercase tracking-widest border-b border-slate-100">
                                                        <tr>
                                                            <th className="px-4 py-3">Tarih</th>
                                                            <th className="px-4 py-3">Uygulama</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody className="divide-y divide-slate-50">
                                                        {fertilizerLogs.slice(0, 15).map((log: any, i: number) => {
                                                            const dateStr = log.date ? new Date(log.date).toLocaleDateString('tr-TR', { day: '2-digit', month: '2-digit' }) : '-';
                                                            const apps: string[] = [];
                                                            if (log.fungusit) apps.push('üß™ Fungusit');
                                                            if (log.aminoAsit) apps.push('üíß Amino Asit');
                                                            if (log.start) apps.push('üöÄ Start');
                                                            if (log.note) apps.push(log.note);
                                                            return (
                                                                <tr key={i} className="hover:bg-slate-50">
                                                                    <td className="px-4 py-3 text-slate-500 font-mono text-xs">{dateStr}</td>
                                                                    <td className="px-4 py-2">
                                                                        <div className="flex flex-wrap gap-1">
                                                                            {apps.map((a, j) => (
                                                                                <span key={j} className="text-[10px] font-bold px-2 py-0.5 rounded-full bg-emerald-50 text-emerald-700 border border-emerald-100">{a}</span>
                                                                            ))}
                                                                        </div>
                                                                    </td>
                                                                </tr>
                                                            );
                                                        })}
                                                        {fertilizerLogs.length === 0 && (
                                                            <tr><td colSpan={2} className="py-8 text-center text-slate-400 italic">Kayƒ±t yok.</td></tr>
                                                        )}
                                                    </tbody>
                                                </table>
                                            </div>

                                            {/* Mobile Card View for Fertilizer Logs */}
                                            <div className="lg:hidden space-y-3 p-4">
                                                {fertilizerLogs.slice(0, 15).map((log: any, i: number) => {
                                                    const dateStr = log.date ? new Date(log.date).toLocaleDateString('tr-TR', { day: 'numeric', month: 'long' }) : '-';
                                                    const apps: string[] = [];
                                                    if (log.fungusit) apps.push('üß™ Fungusit');
                                                    if (log.aminoAsit) apps.push('üíß Amino Asit');
                                                    if (log.start) apps.push('üöÄ Start');
                                                    if (log.note) apps.push(log.note);

                                                    return (
                                                        <div key={i} className="bg-slate-50 p-4 rounded-xl border border-slate-100 flex justify-between items-center">
                                                            <span className="font-bold text-slate-700 text-sm whitespace-nowrap mr-3">{dateStr}</span>
                                                            <div className="flex flex-wrap gap-1 justify-end">
                                                                {apps.map((a, j) => (
                                                                    <span key={j} className="text-[10px] font-bold px-2 py-0.5 rounded-full bg-white text-emerald-700 border border-emerald-100 shadow-sm">{a}</span>
                                                                ))}
                                                                {apps.length === 0 && <span className="text-[10px] text-slate-400">-</span>}
                                                            </div>
                                                        </div>
                                                    );
                                                })}
                                                {fertilizerLogs.length === 0 && <p className="text-slate-400 italic text-sm text-center">Kayƒ±t yok.</p>}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            )}
                        </>
                    )}
                </div>
            </main >
        </div >
    );
}

function KPICard({ icon, label, value, color }: { icon: string, label: string, value: string, color: string }) {
    const colorMap: Record<string, string> = {
        emerald: 'border-emerald-100 bg-emerald-50/30',
        blue: 'border-blue-100 bg-blue-50/30',
        teal: 'border-teal-100 bg-teal-50/30',
        rose: 'border-rose-100 bg-rose-50/30',
        amber: 'border-amber-100 bg-amber-50/30',
    };
    const textMap: Record<string, string> = {
        emerald: 'text-emerald-700',
        blue: 'text-blue-700',
        teal: 'text-teal-700',
        rose: 'text-rose-700',
        amber: 'text-amber-700',
    };
    return (
        <div className={`p-4 rounded-2xl border shadow-sm ${colorMap[color] || colorMap.emerald}`}>
            <div className="text-2xl mb-2">{icon}</div>
            <p className="text-[9px] font-black text-slate-400 uppercase tracking-widest mb-1">{label}</p>
            <p className={`text-lg font-black ${textMap[color] || textMap.emerald}`}>{value}</p>
        </div>
    );
}

function TemperatureChart({ data }: { data: any[] }) {
    if (!data || data.length === 0) return (
        <div className="bg-white rounded-2xl border border-slate-200 shadow-sm p-8 text-center">
            <p className="text-slate-400 italic text-sm">Grafik i√ßin yeterli veri yok.</p>
        </div>
    );

    // Sort data by date, take last 10 entries
    const sortedData = [...data].sort((a, b) => new Date(a.date).getTime() - new Date(b.date).getTime()).slice(-10);

    // Extract max temps per day from seraIci/seraDisi
    const chartData = sortedData.map(d => {
        const si = d.seraIci || {};
        const sd = d.seraDisi || {};
        const insideMax = Math.max(Number(si.sabah || 0), Number(si.ogle || 0), Number(si.aksam || 0));
        const outsideMax = Math.max(Number(sd.sabah || 0), Number(sd.ogle || 0), Number(sd.aksam || 0));
        return { date: d.date, insideMax, outsideMax };
    });

    const temps = chartData.flatMap(d => [d.insideMax, d.outsideMax]);
    const minTemp = Math.min(...temps, 0) - 5;
    const maxTemp = Math.max(...temps, 30) + 5;
    const range = maxTemp - minTemp;

    const w = 1000;
    const h = 200;

    const getX = (i: number) => (i / (Math.max(chartData.length - 1, 1))) * w;
    const getYPix = (val: number) => h - ((val - minTemp) / range) * h;

    const pathInside = chartData.map((d, i) => `${getX(i)},${getYPix(d.insideMax)}`).join(' ');
    const pathOutside = chartData.map((d, i) => `${getX(i)},${getYPix(d.outsideMax)}`).join(' ');

    return (
        <div className="bg-white rounded-2xl border border-slate-200 shadow-sm p-6">
            <div className="flex justify-between items-center mb-6">
                <h3 className="text-[10px] font-black text-slate-400 uppercase tracking-widest">Sƒ±caklƒ±k Deƒüi≈üimi (Son 10 Kayƒ±t ‚Äî G√ºnl√ºk Maks.)</h3>
                <div className="flex gap-4 text-xs font-bold">
                    <div className="flex items-center gap-1"><div className="w-2 h-2 rounded-full bg-orange-500"></div> Sera ƒ∞√ßi</div>
                    <div className="flex items-center gap-1"><div className="w-2 h-2 rounded-full bg-blue-500"></div> Sera Dƒ±≈üƒ±</div>
                </div>
            </div>

            <div className="w-full h-[200px] relative">
                <svg viewBox={`0 0 ${w} ${h}`} className="w-full h-full overflow-visible">
                    {/* Grid lines */}
                    {[0, 0.25, 0.5, 0.75, 1].map(p => (
                        <line key={p} x1="0" y1={p * h} x2={w} y2={p * h} stroke="#e2e8f0" strokeWidth="1" strokeDasharray="5,5" />
                    ))}

                    {/* Paths */}
                    <polyline points={pathOutside} fill="none" stroke="#3b82f6" strokeWidth="3" strokeLinecap="round" strokeLinejoin="round" />
                    <polyline points={pathInside} fill="none" stroke="#f97316" strokeWidth="3" strokeLinecap="round" strokeLinejoin="round" />

                    {/* Dots */}
                    {chartData.map((d, i) => (
                        <g key={i}>
                            <circle cx={getX(i)} cy={getYPix(d.outsideMax)} r="4" fill="white" stroke="#3b82f6" strokeWidth="2" />
                            <circle cx={getX(i)} cy={getYPix(d.insideMax)} r="4" fill="white" stroke="#f97316" strokeWidth="2" />

                            {/* Labels for last point */}
                            {i === chartData.length - 1 && (
                                <>
                                    <text x={getX(i)} y={getYPix(d.outsideMax) - 10} textAnchor="middle" fill="#3b82f6" fontSize="12" fontWeight="bold">{d.outsideMax}¬∞</text>
                                    <text x={getX(i)} y={getYPix(d.insideMax) - 10} textAnchor="middle" fill="#f97316" fontSize="12" fontWeight="bold">{d.insideMax}¬∞</text>
                                </>
                            )}
                        </g>
                    ))}
                </svg>
            </div>

            <div className="flex justify-between mt-2 text-[10px] text-slate-400 font-mono uppercase">
                {chartData.map((d, i) => (
                    <span key={i}>{new Date(d.date).toLocaleDateString('tr-TR', { day: '2-digit', month: '2-digit' })}</span>
                ))}
            </div>
        </div>
    );
}
